
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>sfc2md 联合开发网 - pudn.com</title>

    <link href="/Public/m/css/bootstrap.min.css" rel="stylesheet">
    <link href="/Public/m/font-awesome/css/font-awesome.css" rel="stylesheet">

    <link href="/Public/m/css/animate.css" rel="stylesheet">
    <link href="/Public/m/css/style.css" rel="stylesheet">

	<link href="/Public/m/css/plugins/slick/slick.css" rel="stylesheet">
	<link href="/Public/m/css/plugins/slick/slick-theme.css" rel="stylesheet">

	

	<link href="/css/style.css" rel="stylesheet">

	<!-- Mainly scripts -->
	<script src="/Public/m/js/jquery-2.1.1.js"></script>
	<script src="/Public/m/js/bootstrap.min.js"></script>

	<script src="/Public/m/js/plugins/metisMenu/jquery.metisMenu.js"></script>
	<script src="/Public/m/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

	<!-- Custom and plugin javascript -->
	<script src="/Public/m/js/inspinia.js"></script>
	<script src="/Public/m/js/plugins/pace/pace.min.js"></script>
	
<META name="Keywords" content="sfc2md avr Microcontroller embedded mega-drive super-famicom 程序员 编程 源码 源代码 下载">

	
<META name="Description" content="sfc2md SNES Super Famicom到Genesis Mega Drive控制器适配器">

</head>

<body>

<!-- /.main-container start -->

<div class="pace  pace-inactive">
  	<div class="pace-progress" data-progress-text="100%" data-progress="99" style="transform: translate3d(100%, 0px, 0px);">
  	<div class="pace-progress-inner"></div>
	</div>
	<div class="pace-activity"></div>
</div>

<div class="all-content">
	<div class="my-container top-navigation">
		<nav class="navbar navbar-static-top" role="navigation">
			<div class="navbar-header">
				<button aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse" class="navbar-toggle collapsed" type="button">
					<i class="fa fa-reorder"></i>
				</button>
				<a href="http://www.pudn.com" class="navbar-brand">联合开发网</a>
			</div>
			<div class="navbar-collapse collapse" id="navbar">
				<ul class="nav navbar-nav">
					<li>
						<a href="/" style="padding-right:8px;padding-left:8px;font-size:16px">首页</a>
					</li>
					<li>
						<a href="https://search.pudn.com" style="padding-right:8px;padding-left:8px;font-size:16px">搜索</a>
					</li>
				</ul>
               	<ul class="nav navbar-top-links navbar-right">
               							<li>
                       	<a href="/User/login.html">
                           	&nbsp; <i class="fa fa-sign-out"></i>登录
                       	</a>
                   	</li>
                   	<li>
                       	<a href="/User/reg.html"><i class="fa fa-sign-out"></i>注册
                       	</a>
                   	</li>
					               	</ul>
			</div>
		</nav>
	</div>
	<form action="https://search.pudn.com/Download" method="get">
	<div class="top-menu-line2">
		<div class="my-container">
			<a href=/Download/upload.html>上传</a>
			&nbsp; <a href=/User>管理</a>
			&nbsp; <a href=https://search.pudn.com/Download>搜索</a>
			&nbsp; <a href=/Guestbook>留言</a>
			<div class="input-group pull-right" style="max-width:200px;margin:3px 15px 0px 0px">
				<input type="text" name="keyword" maxlength=20 placeholder="请输入关键字" class="form-control input-sm">
				<span class="input-group-btn"> <button type="submit" class="btn btn-white input-sm" style="border:1px solid #AAA"><i class="fa fa-search"></i></button>
				</span>
			</div>
		</div>
	</div></form>



<div class="row wrapper white-bg">
	<div class="my-container">
			<div class="nav-dir" style="padding:10px 0px">
				<a href="/">Pudn.com</a>&nbsp;&gt;&nbsp;下载中心
				&nbsp;&gt;&nbsp;处理器开发				&nbsp;&gt;&nbsp;<font color=red>sfc2md</font>
			</div>


		<div class="row">
			<div class="col-xs-12 col-md-8">
				<div class="item-name">sfc2md</div>
				<div class="item-keyword">
					<a href="#" class="keyword" keyword="avr">avr</a>&nbsp;<a href="#" class="keyword" keyword="Microcontroller">Microcontroller</a>&nbsp;<a href="#" class="keyword" keyword="embedded">embedded</a>&nbsp;<a href="#" class="keyword" keyword="mega-drive">mega-drive</a>&nbsp;<a href="#" class="keyword" keyword="super-famicom">super-famicom</a>&nbsp;				</div>
				<div class="item-action">
					<div class="btn-group">
						<a href=/Download/dl/id/1687219497324455 target=_blank class="btn btn-primary btn-sm"><i class="fa fa-download"></i> 下载(<span id="down-count">0</span>)</a>
						<a href="###" class="btn btn-white btn-sm vote-up"><i class="fa fa-thumbs-up"></i> 赞(<span id="vote-up-count">4</span>) </a>
						<a href="###" class="btn btn-white btn-sm vote-down"><i class="fa fa-thumbs-down"></i> 踩(<span id="vote-down-count">0</span>) </a>
						<a href="/Download/comment/id/1687219497324455" data-toggle="modal" data-target="#myModal" class="btn btn-white btn-sm"><i class="fa fa-comment"></i> 评论(<span id="comment-count">0</span>) </a>
						<a href="###" class="btn btn-white btn-sm favor-item"><i class="fa fa-heart"></i> 收藏(<span id="favor-count">0</span>) </a>
					</div>
				</div>
				<hr>

				<div class="item-info">
					<B>所属分类</B>：处理器开发<BR>
					<B>开发工具</B>：C<BR>
					<B>文件大小</B>：860KB<BR>
					<B>下载次数</B>：0<BR>
					<B>上传日期</B>：2020-06-22 17:47:28<BR>
					<B>上 传 者</B>：<a href=/User/profile/id/1682139907912860.html>sh-1993</a><BR>
				</div>
				<div class="item-intro">
					说明：&nbsp;&nbsp;SNES Super Famicom到Genesis Mega Drive控制器适配器<BR>(SNES Super Famicom to Genesis Mega Drive controller adapter)				</div>
				<hr>
				<div><B>文件列表</B>: </div>
				<div id="file-list">
				LICENSE (1267, 2020-06-23)<BR>Makefile (543, 2020-06-23)<BR>adapter.<B>jpg</B> (803092, 2020-06-23)<BR>de9.<B>png</B> (45648, 2020-06-23)<BR>sfc2md.<B>c</B> (12014, 2020-06-23)<BR>sfcplug.<B>png</B> (26949, 2020-06-23)<BR>				</div>
				<hr>
				<div id="readme">
				# sfc2md

This program for AVR microcontrollers allows playing Genesis/Mega Drive with a
Super Nintendo/Super Famicom controller.

# Features

This program emulates a 6-button controller by default.  It was created
primarily to play Xeno Crisis, so the default button mapping is optimized for
that game: face buttons shoot directionally, R rolls, L throws grenade, Select
drops weapon, Start pauses.

For games that use A as primary action and B to jump (and C for a secondary
action, if applicable), hold Left on the controller when powering on the
console.  This maps action and jump to Y and B on the controller, and A to the
secondary action, which is typical and intuitive for SNES/SFC games.

For games that use B as the primary action and C to jump (and A for a secondary
action), hold Right when powering on instead.

In either of the above mappings, L, X, and R on the controller map to
Genesis/MD buttons X, Y, and Z respectively.  Start and Select always map to
Start and Mode.

To act as a 3-button controller, hold Select when powering on the console.
This can be combined with one of the above directions.  Some games may require
this, although in my testing so far I've found this adapter to be more
compatible than the official 6-button controller.

The adapter introduces about 1.67 milliseconds of input latency on NTSC region
(60 Hz) games.  It introduces 5 milliseconds on PAL region (50 Hz) games -- not
ideal, but so is playing Mega Drive games at 50 Hz.

# Building the Code

A simple `Makefile` is provided.  The `upload` target will program an
ATmega32U4 on Linux with `avrdude`.  You may need to modify the file for your
MCU, OS, and programmer.

# Hardware and Requirements

The prototype uses an ATmega32U4 board and some spare controller/extension cables
spliced together.  I used Dupont connectors and put it in an old AC adapter housing
to keep things a bit more clean.

![Adapter photograph](https://github.com/bkoropoff/sfc2md/blob/master/adapter.jpg)

The MCU needs to run at 16MHz or more to keep up with the Genesis/MD.  Pin
assignments may need to be changed depending on your MCU and wiring.

The best way to get the appropriate plugs is to buy extension cables and cut
them up.  You will want to wire the plugs to your MCU as follows:

## Genesis/Mega Drive connector (DE-9)

Looking into the connector on the controller cable (be sure not to get this
reversed!):

![Genesis (DE-9) connector](https://github.com/bkoropoff/sfc2md/blob/master/de9.png)

| Pin | Name   |
|-----|--------|
| 1   | D0     |
| 2   | D1     |
| 3   | D2     |
| 4   | D3     |
| 5   | +5V    |
| 6   | D4     |
| 7   | Select |
| 8   | GND    |
| 9   | D5     |

## SNES/Super Famicom connector (proprietary)

The shape of the connector makes orientation unambiguous, thankfully:

![SNES connector](https://github.com/bkoropoff/sfc2md/blob/master/sfcplug.png)

| Pin | Name   |
|-----|--------|
| 1   | GND    |
| 2   | Unused |
| 3   | Unused |
| 4   | Data   |
| 5   | Latch  |
| 6   | Clock  |
| 7   | +5V    |

## MCU

The default pin assignments using the same names as in the above tables are
found prominently in the [source code](https://github.com/bkoropoff/sfc2md/blob/master/sfc2md.c).  If you aren't using the same
board that I am, you'll most likely have to change them to match your wiring.
All Genesis/MD data lines (D0-D5) must be on the same port register so that
they can be updated in a single instruction.

I noticed substantial crosstalk during output switching on my oscilloscope, so
you may want to put small resistors on the Genesis/MD data lines (D0-D5) to
limit slew rate.  It worked fine regardless.

# Implementation Notes

The implementation is highly optimized in order to keep up with the stringent
timing requirements of Genesis/MD controller polling.  The original 3-button
controller is simply a high-speed CMOS multiplexer on the end of a cable, so it
can be expected to switch outputs within 10 nanoseconds or so.  Many games are
therefore very aggressive about reading the outputs after toggling the select
line.  My testing suggests that response times need to be kept under 700
nanoseconds or so to prevent games from reading bogus inputs.

To respond as quickly as possible, the select line is polled using busy waits
in a manually unrolled main loop.  The generated assembly was inspected
to ensure that each busy wait consists of a two-instruction loop followed by
an immediate write to the output port register once the select line toggles.

The 6-button controller exposes additional buttons by a "handshake" with the
game where it polls the controller extra times each frame.  After two polling
cycles within a short time window, the third negative edge of the select line
causes the controller to drive D0-D4 low.  This is normally impossible (it
would indicate all 4 cardinal directions on the directional pad being pressed
simultaneously), so it identifies the controller as being 6-button to the game.
On the following positive edge, the additional button states are output on
D0-D4.

To maintain backward compatibility with games expecting 3-button controllers,
the 6-button controller reverts to 3-button behavior if the game does not
complete all polling cycles within a millisecond or so.  This program uses
a timer interrupt to accomplish the same behavior.  To prevent slowing down
the busy waits with tests for a timeout flag, the interrupt instead overwrites
the return address on the stack so that the main loop immediately jumps to
a special label upon return, resetting the loop.  This is also when polling
of the SNES/SFC controller is performed.  The timeout is tuned so that the
SNES/SFC controller is polled as close as possible to the game polling the
adapter, minimizing input latency.

The SNES/SFC controller is essentially a 16-bit shift register on the end of a
cable, so polling it consists of issuing a pulse to latch the inputs into the
register, followed by clocking out the button states one at a time.  The
timings used are approximately those used by a real console, so controller
compatibility should be high.
				</div>
				<hr>
				<div><B>近期下载者</B>：</div>
				<div id="download-users"></div>
				<hr>
				<div><B>相关文件</B>：</div>
				<div id="relate-items"></div>
				<hr>
				<div><B>评论</B>：[<a href=/Download/comment/id/1687219497324455.html data-toggle=modal data-target="#myModal">我要评论</a>]&nbsp;[<a class='pop-a' href=/Download/report/id/1687219497324455.html>举报此文件</a>]</div>
				<div id="file-comments"></div>
				<hr>
				<div><B>收藏者</B>：</div>
				<div id="favor-users"></div>
				<p></p>
			</div>

			<div class="col-xs-12 col-md-4">

				<div class="ad-sidebar text-center">
					<div class="ad-300">
					</div>
				</div>
			</div>
		</div>

	</div>
</div>



	<div class="my-footer">
		<div class="container">
		<div class="pull-right">
		</div>

		<div>
			
			<a href="http://www.pudn.com" target=_blank>© 联合开发网 from 2004</a> | 
			<a href="/Index/contact.html">联系站长</a> | 
			<a href=" https://beian.miit.gov.cn" target=_blank>湘ICP备2023001425号</a> | 
			<a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43010502000604" target=_blank>网安备43010502000604</a> | 
		</div>
		</div>
	</div>


</div><!-- /wrapper-->




<!-- page specific plugin scripts -->

<!-- inline scripts related to this page -->

<div id="myModal" class="modal fade" tabindex="-1" 
			role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			
		</div>
	</div>
</div><!-- /.modal-table -->

</body>

<script type="text/javascript">
$(document).on('click', '.list-more', function(){
	var id=$(this).attr('data-id');
	$('#list-'+id).css('max-height',$('#list-'+id)[0].scrollHeight);
	$(this).removeClass('list-more');
	$(this).addClass('list-hide');
	$(this).html('<i class="fa fa-angle-double-up"></i>');
	
	//$(this).hide();

	return false;
});

$(document).on('click', '.list-hide', function(){
	var id=$(this).attr('data-id');
	$('#list-'+id).css('max-height','100px');
	$(this).removeClass('list-hide');
	$(this).addClass('list-more');
	$(this).html('<i class="fa fa-angle-double-down"></i>');
	
	return false;
});

$("#myModal").on("hidden.bs.modal", function() {
    $(this).removeData();
});

$(document).on("click",".keyword",function(){
	var keyword=$(this).attr("keyword");
	var type_id=$(this).attr("type_id");
	if(typeof(type_id) =="undefined" || type_id =="") type_id="0";
	location.href="http://search.pudn.com/Download/index?keyword="+keyword;
	
	return false;
});
</script>
<script type="text/javascript" src="/js/time.js"></script>


<script type="text/javascript" src="/js/marked.min.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$('.hide-list').each(function(){
			if ($(this)[0].offsetHeight < $(this)[0].scrollHeight){
				var id=$(this).attr('id');
				id =id.substring(5);
				$(this).after('<div style="text-align:center"><a href="" class="list-more" data-id="' + id + '"><i class="fa fa-angle-double-down"></i></a></div>');
			}
		});
	});
	var g_id="1687219497324455";
	var keywords =new Array();
	keywords[0] ='avr';keywords[1] ='Microcontroller';keywords[2] ='embedded';keywords[3] ='mega-drive';keywords[4] ='super-famicom';	function get_download_user(){
		var url ="/Download/get_download_user/id/"+g_id+".html";
		$.get(url,function(ret){
			if(ret.length ==0) return;
			var html='';
			for(i in ret){
				html =html + '<a href=/User/profile/id/'+ret[i].user_new_id+'.html>'+ret[i].name+'</a> ';
			}
			$('#download-users').append(html);
		});
	}
	
	function get_relate_item(){
		var url ="/Download/get_relate_item/id/"+g_id+'.html';
		$.get(url,function(ret){
			if(ret.length ==0) return;
			var html='';
			var intro;
			for(i in ret){
				intro =ret[i].intro;
				for(j in keywords){
					var reg =new RegExp(keywords[j],'gmi');
					intro =intro.replace(reg,'<font color=brown>'+keywords[j]+'</font>');
				}
				html =html + '[<a href=/Download/item/id/'+ret[i].new_id+'.html>'+ret[i].name+'</a>]&nbsp; '+intro+'<BR>';
			}
			$('#relate-items').append(html);
		});
		
	}
	function get_score_name(score){
		switch(score){
		case '100': return '很好，推荐下载';
		case '85': return '还不错';
		case '75': return '一般，勉强可用';
		case '50': return '差';
		case '3': return '纯粹是垃圾';
		case '40': return '和说明完全不符';
		case '20': return '文件不全';
		case '10': return '不是源代码或资料';
		case '5': return '文件有密码，不知道密码';
		case '0': return '不能解压或下载失败';
		}
		return '';
	}
	function get_comment(){
		var url ="/Download/get_comments/id/"+g_id+'.html';
		$.get(url,function(ret){
			if(ret.length ==0) return;
			var total_count =ret.total_count;
			var data =ret.data;
			var html='';
			for(i in data){
				html =html + '<a href="/User/profile/id/'+data[i].user_new_id+'.html" class="uploader">'+data[i].user_name+'</a>: <span class="comment-score">'+get_score_name(data[i].score)+'</span>, '+data[i].content+'<BR>';
			}
			$('#file-comments').append(html);
		});
		
	}
	function get_favor(){
		var url ="/Download/get_item_favors/id/"+g_id+".html";
		$.get(url,function(ret){
			if(ret.length ==0) return;
			var html='';
			for(i in ret){
				html =html + '<a href=/User/profile/id/'+ret[i].user_new_id+'.html class=user>'+ret[i].name+'</a>&nbsp;';
			}
			$('#favor-users').html(html);
		});
	}
	// 得到下载这个的用户又下载了什么
	function get_more_download(){
		
	}
	// 得到下载这个的用户又搜索了什么
	function get_more_keyword(){
		
	}
	
	// 得到论坛相关问题
	function get_bbs(){
		
	}
	
	// 得到软件工场相关内容
	function get_works(){
		
	}
	
	// 得到相关聊天室
	function get_chat(){
		
	}
	
	// 得到相关软件商城信息
	function get_shop(){
		
	}
	
	// 得到job
	
	// 得到学习内容

	// 数据
	get_download_user();
	//get_relate_item();
	get_comment();
	get_favor();
	
	$('.vote-up').click(function(){
		var url="/Download/vote/t/up/id/"+g_id;
		$.get(url,function(ret){
			if(ret.status==0){
				alert(ret.info);
				if(ret.url.length >0)
					location.href=ret.url;
			}
			else{
				var s =$('#vote-up-count').html();
				if(s =='') s="0";
				var count =parseInt(s)+1;
				$('#vote-up-count').html(count);
			}
		})
		return false;
	});
	$('.vote-down').click(function(){
		var url="/Download/vote/t/down/id/"+g_id;
		$.get(url,function(ret){
			if(ret.status==0)
				alert(ret.info);
			else{
				var s =$('#vote-down-count').html();
				if(s =='') s="0";
				var count =parseInt(s)+1;
				$('#vote-down-count').html(count);
			}
		})
		return false;
	});
	$('.favor-item').click(function(){
		var url="/Favor/add/t/0/id/"+g_id;
		$.get(url,function(ret){
			if(ret.status==0){
				alert(ret.info);
			}
			else{
				var s =$('#favor-count').html();
				if(s =='') s="0";
				var count =parseInt(s)+1;
				$('#favor-count').html(count);
			}
		})
		return false;
	});
	$('.pop-a').click(function(){
		var url=$(this).attr('href');
		$.get(url,function(ret){
			alert(ret.info);
			//location.reload();
		})
		return false;
	});

document.getElementById('readme').innerHTML =marked.parse(document.getElementById('readme').innerHTML);
</script>



</html>